import json
from app.services.llm_service import get_llm_response

async def plan_execution(user_request: str, framing_context: str) -> dict:
    """
    –í–∏–∑–Ω–∞—á–∞—î, —è–∫—ñ –∞–≥–µ–Ω—Ç–∏ –ø–æ—Ç—Ä—ñ–±–Ω—ñ –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–∞–≤–¥–∞–Ω–Ω—è.
    –ü–æ–≤–µ—Ä—Ç–∞—î —Å–ª–æ–≤–Ω–∏–∫: {"market": True, "competitors": False, ...}
    """
    print("üö¶ [Router] Analyzing request intent...")

    system_prompt = """
    –¢–∏ - Orchestrator Router. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –≤–∏–∑–Ω–∞—á–∏—Ç–∏, —è–∫—ñ –µ–∫—Å–ø–µ—Ä—Ç–∏ (–∞–≥–µ–Ω—Ç–∏) –ø–æ—Ç—Ä—ñ–±–Ω—ñ –¥–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –Ω–∞ –∑–∞–ø–∏—Ç –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.
    
    –î–æ—Å—Ç—É–ø–Ω—ñ –∞–≥–µ–Ω—Ç–∏:
    1. **market_agent**: –ü–æ—Ç—Ä—ñ–±–µ–Ω, —è–∫—â–æ –∑–∞–ø–∏—Ç —Å—Ç–æ—Å—É—î—Ç—å—Å—è –æ–±'—î–º—É —Ä–∏–Ω–∫—É, —Ç—Ä–µ–Ω–¥—ñ–≤, –ø–æ–ø–∏—Ç—É, –≥–µ–æ–≥—Ä–∞—Ñ—ñ—ó, —Ä–µ–≥—É–ª—è—Ü—ñ–π.
    2. **competitor_agent**: –ü–æ—Ç—Ä—ñ–±–µ–Ω, —è–∫—â–æ —Ç—Ä–µ–±–∞ –∑–Ω–∞–π—Ç–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ñ–≤, —ó—Ö–Ω—ñ —Ü—ñ–Ω–∏, SWOT –∞–±–æ –ø–æ—Ä—ñ–≤–Ω—è—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç–∏.
    3. **finance_agent**: –ü–æ—Ç—Ä—ñ–±–µ–Ω, —è–∫—â–æ –∑–∞–ø–∏—Ç –ø—Ä–æ –ø—Ä–∏–±—É—Ç–∫–æ–≤—ñ—Å—Ç—å, –≤–∏—Ç—Ä–∞—Ç–∏, Unit Economics, P&L, break-even.
    4. **risk_agent**: –ü–æ—Ç—Ä—ñ–±–µ–Ω –ó–ê–í–ñ–î–ò –¥–ª—è –æ—Ü—ñ–Ω–∫–∏ —Ä–∏–∑–∏–∫—ñ–≤ (—Ä–∏–Ω–∫–æ–≤—ñ/–æ–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ/—Ä–µ–≥—É–ª—è—Ç–æ—Ä–Ω—ñ) —Ç–∞ –º—ñ—Ç–∏–≥–∞—Ü—ñ–π. –í–∏–º–∏–∫–∞–π –ª–∏—à–µ —è–∫—â–æ –∑–∞–ø–∏—Ç —Å—É—Ç–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω–∏–π.
    5. **frameworks_agent**: –ü–æ—Ç—Ä—ñ–±–µ–Ω, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–µ–Ω —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–∏–π —Å—Ç—Ä–∞—Ç–µ–≥—ñ—á–Ω–∏–π –∞–Ω–∞–ª—ñ–∑ (Porter, JTBD —Ç–æ—â–æ).
    
    –ü–†–ê–í–ò–õ–ê:
    - –Ø–∫—â–æ –∑–∞–ø–∏—Ç –∑–∞–≥–∞–ª—å–Ω–∏–π ("–°—Ç–≤–æ—Ä–∏ —Å—Ç—Ä–∞—Ç–µ–≥—ñ—é", "–ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π —ñ–¥–µ—é", "–ß–∏ –≤–∞—Ä—Ç–æ –∑–∞–ø—É—Å–∫–∞—Ç–∏?"), –≤–º–∏–∫–∞–π –í–°–Ü–• –∞–≥–µ–Ω—Ç—ñ–≤.
    - –Ø–∫—â–æ –∑–∞–ø–∏—Ç —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω–∏–π ("–•—Ç–æ –º–æ—ó –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∏?"), –≤–º–∏–∫–∞–π —Ç—ñ–ª—å–∫–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∏—Ö.
    - Risk Agent (risks) –≤–º–∏–∫–∞–π –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º, —è–∫—â–æ —î —Ö–æ—á —è–∫–∏–π—Å—å –±—ñ–∑–Ω–µ—Å-–∫–æ–Ω—Ç–µ–∫—Å—Ç.
    
    –í–ê–ñ–õ–ò–í–û: –ü–æ–≤–µ—Ä–Ω–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –¢–Ü–õ–¨–ö–ò —É —Ñ–æ—Ä–º–∞—Ç—ñ JSON. –ë–µ–∑ –ø–æ—è—Å–Ω–µ–Ω—å, –±–µ–∑ markdown.
    –§–æ—Ä–º–∞—Ç:
    {
        "market": true,
        "competitors": true,
        "finance": true,
        "risks": true,
        "frameworks": true
    }
    """

    user_prompt = f"""
    –ó–∞–ø–∏—Ç –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: "{user_request}"
    –ö–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á—ñ: "{framing_context}"
    
    –Ø–∫–∏—Ö –∞–≥–µ–Ω—Ç—ñ–≤ –≤–∏–∫–ª–∏–∫–∞—Ç–∏?
    """

    response_text = await get_llm_response(user_prompt, system_message=system_prompt, agent="router_agent")
    
    # –ß–∏—Å—Ç–∏–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å (—ñ–Ω–æ–¥—ñ LLM –¥–æ–¥–∞—î ```json ... ```)
    cleaned_text = response_text.replace("```json", "").replace("```", "").strip()
    
    try:
        plan = json.loads(cleaned_text)
        return plan
    except json.JSONDecodeError:
        print("‚ö†Ô∏è Router failed to produce JSON, activating ALL agents fallback.")
        # Fallback: —è–∫—â–æ JSON –ø–æ–ª–∞–º–∞–≤—Å—è, –∑–∞–ø—É—Å–∫–∞—î–º–æ –≤—Å–µ
        return {"market": True, "competitors": True, "finance": True, "risks": True, "frameworks": True}