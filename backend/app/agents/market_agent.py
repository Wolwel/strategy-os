from app.services.llm_service import get_llm_response
from app.services.search_service import search_web

async def run_market_analysis(framing_context: str) -> str:
    """
    –ê–≥–µ–Ω—Ç –¥–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è —Ä–∏–Ω–∫—É.
    1. –ì–µ–Ω–µ—Ä—É—î –ø–æ—à—É–∫–æ–≤–∏–π –∑–∞–ø–∏—Ç.
    2. –®—É–∫–∞—î –¥–∞–Ω—ñ.
    3. –†–æ–±–∏—Ç—å –∑–≤—ñ—Ç.
    """
    
    # --- –ï–¢–ê–ü 1: –ì–µ–Ω–µ—Ä—É—î–º–æ –ø–æ—à—É–∫–æ–≤–∏–π –∑–∞–ø–∏—Ç ---
    query_prompt = f"""
    –û—Å—å –æ–ø–∏—Å –±—ñ–∑–Ω–µ—Å-–∑–∞–¥–∞—á—ñ:
    "{framing_context}"
    
    –ù–∞–ø–∏—à—ñ—Ç—å –û–î–ò–ù –Ω–∞–π–∫—Ä–∞—â–∏–π –ø–æ—à—É–∫–æ–≤–∏–π –∑–∞–ø–∏—Ç –¥–ª—è Google, —â–æ–± –∑–Ω–∞–π—Ç–∏ —Ä–∏–Ω–∫–æ–≤—ñ –¥–∞–Ω—ñ, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç–∞ —Ç—Ä–µ–Ω–¥–∏ –¥–ª—è —Ü—ñ—î—ó –Ω—ñ—à—ñ –≤ —Ü—å–æ–º—É —Ä–µ–≥—ñ–æ–Ω—ñ.
    –ó–∞–ø–∏—Ç –º–∞—î –±—É—Ç–∏ –∫–æ—Ä–æ—Ç–∫–∏–º —ñ —Ç–æ—á–Ω–∏–º. –¢—ñ–ª—å–∫–∏ —Ç–µ–∫—Å—Ç –∑–∞–ø–∏—Ç—É, –±–µ–∑ –ª–∞–ø–æ–∫ —ñ –ø–æ—è—Å–Ω–µ–Ω—å.
    """
    search_query = await get_llm_response(query_prompt, system_message="–¢–∏ –µ–∫—Å–ø–µ—Ä—Ç –∑ –ø–æ—à—É–∫—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó.", agent="market_agent")
    print(f"   [Market Agent] Generated Query: {search_query}") # –õ–æ–≥—É–≤–∞–Ω–Ω—è

    if not search_query or str(search_query).strip() == "N/A":
        return "N/A"
    
    # --- –ï–¢–ê–ü 2: –ü–æ—à—É–∫ ---
    search_data = await search_web(search_query)
    # Guard against context-length errors from very large web dumps
    if isinstance(search_data, str) and len(search_data) > 6000:
        search_data = search_data[:6000] + "\n\n[truncated]"
    
    # --- –ï–¢–ê–ü 3: –ê–Ω–∞–ª—ñ–∑ ---
    analysis_prompt = f"""
    –¢–∏ - Market Intelligence Agent. –¢–≤–æ—è —Ü—ñ–ª—å - –ß–ï–°–ù–û –æ—Ü—ñ–Ω–∏—Ç–∏ –ø—Ä–∏–≤–∞–±–ª–∏–≤—ñ—Å—Ç—å —Ä–∏–Ω–∫—É.
    
    ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û –í–ê–ñ–õ–ò–í–Ü –ü–†–ê–í–ò–õ–ê:
    1. –Ø–∫—â–æ –¥–∞–Ω–∏—Ö –ù–ï–î–û–°–¢–ê–¢–ù–¨–û –¥–ª—è —Ç–æ—á–Ω–æ—ó –æ—Ü—ñ–Ω–∫–∏ - –°–ö–ê–ñ–ò –ü–†–û –¶–ï –ü–†–Ø–ú–û.
    2. –ß—ñ—Ç–∫–æ —Ä–æ–∑–¥—ñ–ª—è–π –§–ê–ö–¢–ò (–∑ –¥–∂–µ—Ä–µ–ª) —Ç–∞ –ü–†–ò–ü–£–©–ï–ù–ù–Ø (—Ç–≤–æ—ó –æ—Ü—ñ–Ω–∫–∏).
    3. –í–∫–∞–∑—É–π —Ä—ñ–≤–µ–Ω—å –≤–ø–µ–≤–Ω–µ–Ω–æ—Å—Ç—ñ: üü¢ –í–∏—Å–æ–∫–∏–π (—î –¥–∞–Ω—ñ) / üü° –°–µ—Ä–µ–¥–Ω—ñ–π / üî¥ –ù–∏–∑—å–∫–∏–π (–ø—Ä–∏–ø—É—â–µ–Ω–Ω—è).
    4. –ù–ï –í–ò–ì–ê–î–£–ô —Ü–∏—Ñ—Ä–∏. –ö—Ä–∞—â–µ –Ω–∞–ø–∏—Å–∞—Ç–∏ "–¥–∞–Ω—ñ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ", –Ω—ñ–∂ –Ω–µ–ø—Ä–∞–≤–¥—É.
    5. –Ø–∫—â–æ —Ä–∏–Ω–æ–∫ –≤–∏–≥–ª—è–¥–∞—î –ü–û–ì–ê–ù–ò–ú - —Å–∫–∞–∂–∏ —Ü–µ –ø—Ä—è–º–æ.
    
    –í—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ (–ö–æ–Ω—Ç–µ–∫—Å—Ç):
    {framing_context}
    
    –ó–Ω–∞–π–¥–µ–Ω—ñ –¥–∞–Ω—ñ –∑ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—É:
    {search_data}
    
    ### –§–û–†–ú–ê–¢ –ó–í–Ü–¢–£ (–ö–û–†–û–¢–ö–û!):
    
    ## üìä –†–∏–Ω–æ–∫
    
    | –ü–æ–∫–∞–∑–Ω–∏–∫ | –ó–Ω–∞—á–µ–Ω–Ω—è | –í–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—å |
    |----------|----------|-------------|
    | TAM | $X | üü¢/üü°/üî¥ |
    | SAM | $X | üü¢/üü°/üî¥ |
    | SOM (1 —Ä—ñ–∫) | $X | üü¢/üü°/üî¥ |
    
    **–¢—Ä–µ–Ω–¥–∏:** 2-3 –∫–ª—é—á–æ–≤—ñ —Ç—Ä–µ–Ω–¥–∏ (üìà —Ä–æ—Å—Ç–µ / üìâ –ø–∞–¥–∞—î)
    
    **–†–µ–≥—É–ª—è—Ü—ñ—ó:** –õ—ñ—Ü–µ–Ω–∑—ñ—ó –ø–æ—Ç—Ä—ñ–±–Ω—ñ? –¢–∞–∫/–ù—ñ. –Ø–∫—ñ —Å–∞–º–µ (–∫–æ—Ä–æ—Ç–∫–æ).
    
    ## üéØ –í–µ—Ä–¥–∏–∫—Ç
    - **–ü—Ä–∏–≤–∞–±–ª–∏–≤—ñ—Å—Ç—å:** üü¢ –í–∏—Å–æ–∫–∞ / üü° –°–µ—Ä–µ–¥–Ω—è / üî¥ –ù–∏–∑—å–∫–∞
    - **–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ñ—Å—Ç—å:** X/10
    - **–ì–æ–ª–æ–≤–Ω–∏–π —Ä–∏–∑–∏–∫:** 1 —Ä–µ—á–µ–Ω–Ω—è
    - **–í–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—å:** X%
    
    ‚ö†Ô∏è **–ù–µ–≤—ñ–¥–æ–º–æ:** –©–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ (1-2 –ø—É–Ω–∫—Ç–∏)
    
    –ë—É–¥—å –õ–ê–ö–û–ù–Ü–ß–ù–ò–ú. –ú–∞–∫—Å–∏–º—É–º 150 —Å–ª—ñ–≤.
    """
    
    market_report = await get_llm_response(
        analysis_prompt,
        system_message="–¢–∏ –¥–æ—Å–≤—ñ–¥—á–µ–Ω–∏–π —Ä–∏–Ω–∫–æ–≤–∏–π –∞–Ω–∞–ª—ñ—Ç–∏–∫. –¢–≤–æ—è —Ä–µ–ø—É—Ç–∞—Ü—ñ—è –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —Ç–æ—á–Ω–æ—Å—Ç—ñ –ø—Ä–æ–≥–Ω–æ–∑—ñ–≤, —Ç–æ–º—É —Ç–∏ –Ω—ñ–∫–æ–ª–∏ –Ω–µ –ø—Ä–∏–∫—Ä–∞—à–∞—î—à —Ä–µ–∞–ª—å–Ω—ñ—Å—Ç—å.",
        agent="market_agent",
    )
    return market_report