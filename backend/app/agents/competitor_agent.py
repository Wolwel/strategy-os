from app.services.llm_service import get_llm_response
from app.services.search_service import search_web

async def run_competitor_analysis(framing_context: str, market_data: str) -> str:
    """
    –ó–Ω–∞—Ö–æ–¥–∏—Ç—å –ø—Ä—è–º–∏—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ñ–≤ —ñ —Ä–æ–±–∏—Ç—å –∞–Ω–∞–ª—ñ–∑ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–≥–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞.
    """
    
    # 1. –ì–µ–Ω–µ—Ä—É—î–º–æ –∑–∞–ø–∏—Ç –Ω–∞ –ø–æ—à—É–∫ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ñ–≤
    query_prompt = f"""
    –ó–∞–¥–∞—á–∞: {framing_context}
    –†–∏–Ω–æ–∫: {market_data}
    
    –ù–∞–ø–∏—à—ñ—Ç—å –ø–æ—à—É–∫–æ–≤–∏–π –∑–∞–ø–∏—Ç –¥–ª—è Google, —â–æ–± –∑–Ω–∞–π—Ç–∏ 3-5 –ø—Ä—è–º–∏—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ñ–≤ —É —Ü—ñ–π –Ω—ñ—à—ñ —Ç–∞ —ó—Ö–Ω—ñ —Ü—ñ–Ω–∏/–≤—ñ–¥–≥—É–∫–∏.
    –¢–∞–∫–æ–∂ –ø–æ—à—É–∫–∞–π —Å—Ç–∞—Ä—Ç–∞–ø–∏, —è–∫—ñ –ó–ê–ö–†–ò–õ–ò–°–¨ —É —Ü—ñ–π –Ω—ñ—à—ñ.
    –¢—ñ–ª—å–∫–∏ —Ç–µ–∫—Å—Ç –∑–∞–ø–∏—Ç—É.
    """
    search_query = await get_llm_response(query_prompt, agent="competitor_agent")
    
    # –û–±—Ä—ñ–∑–∞—î–º–æ –∑–∞–ø–∏—Ç –¥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ—ó –¥–æ–≤–∂–∏–Ω–∏ Tavily API (400 —Å–∏–º–≤–æ–ª—ñ–≤)
    if len(str(search_query)) > 400:
        search_query = str(search_query)[:397] + "..."
    
    print(f"   [Competitor Agent] Searching: {search_query}")

    if not search_query or str(search_query).strip() == "N/A":
        return "N/A"
    
    search_results = await search_web(search_query)
    # Guard against context-length errors from very large web dumps
    if isinstance(search_results, str) and len(search_results) > 6000:
        search_results = search_results[:6000] + "\n\n[truncated]"
    
    # 2. –ê–Ω–∞–ª—ñ–∑ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ñ–≤
    analysis_prompt = f"""
    –¢–∏ - Competitive Analysis Agent. –¢–≤–æ—è –º–µ—Ç–∞ - –ó–ê–•–ò–°–¢–ò–¢–ò –∫–ª—ñ—î–Ω—Ç–∞ –≤—ñ–¥ –≤–∏—Ö–æ–¥—É –Ω–∞ –ø—Ä–æ–≥—Ä–∞—à–Ω–∏–π —Ä–∏–Ω–æ–∫.
    
    ‚ö†Ô∏è –¢–í–û–Ø –ú–Ü–°–Ü–Ø: –ü–æ–∫–∞–∑–∞—Ç–∏ –†–ï–ê–õ–¨–ù–£ –∫–∞—Ä—Ç–∏–Ω—É –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü—ñ—ó, –∞ –Ω–µ "–≤—Å–µ –±—É–¥–µ –¥–æ–±—Ä–µ".
    
    –í—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ:
    {framing_context}
    
    –ó–Ω–∞–π–¥–µ–Ω—ñ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∏:
    {search_results}
    
    ### –§–û–†–ú–ê–¢ –ó–í–Ü–¢–£ (–ö–û–†–û–¢–ö–û!):
    
    ## üéØ –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–∏
    
    | –ù–∞–∑–≤–∞ | –°–∏–ª—å–Ω—ñ —Å—Ç–æ—Ä–æ–Ω–∏ | –°–ª–∞–±–∫–æ—Å—Ç—ñ | –¶—ñ–Ω–∏ |
    |-------|----------------|-----------|------|
    (–¢–æ–ø-3 –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∏)
    
    **ü™¶ –ü—Ä–æ–≤–∞–ª–∏:** –•—Ç–æ –∑–∞–∫—Ä–∏–≤—Å—è —ñ —á–æ–º—É? (1-2 –ø—Ä–∏–∫–ª–∞–¥–∏ –∞–±–æ "–¥–∞–Ω—ñ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ")
    
    ## üéØ –í–µ—Ä–¥–∏–∫—Ç
    - **–°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å –≤—Ö–æ–¥—É:** üü¢ –õ–µ–≥–∫–æ / üü° –°–∫–ª–∞–¥–Ω–æ / üî¥ –î—É–∂–µ –≤–∞–∂–∫–æ
    - **–ú—ñ–Ω. –±—é–¥–∂–µ—Ç:** $X/–º—ñ—Å –Ω–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥
    - **–ß–∞—Å –¥–æ –≤–ø—ñ–∑–Ω–∞–≤–∞–Ω–æ—Å—Ç—ñ:** X –º—ñ—Å—è—Ü—ñ–≤
    - **–ë—ñ–ª–∞ –ø–ª—è–º–∞:** –©–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∏ —Ä–æ–±–ª—è—Ç—å –ø–æ–≥–∞–Ω–æ? (1 –ø—É–Ω–∫—Ç)
    
    –ë—É–¥—å –õ–ê–ö–û–ù–Ü–ß–ù–ò–ú. –ú–∞–∫—Å–∏–º—É–º 120 —Å–ª—ñ–≤.
    """
    
    return await get_llm_response(analysis_prompt, temperature=0.3, agent="competitor_agent")